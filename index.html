<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arknights Endfield - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–ª–∏–≥–∞—Ü–∏–π</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            color: #ffd700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .panel h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 10px;
        }
        .region-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .region-btn {
            padding: 15px 25px;
            border: 2px solid #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
            color: #4fc3f7;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .region-btn:hover {
            background: rgba(79, 195, 247, 0.2);
        }
        .region-btn.active {
            background: #4fc3f7;
            color: #1a1a2e;
            font-weight: bold;
        }
        .outpost-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .outpost-btn {
            padding: 10px 20px;
            border: 1px solid #888;
            background: rgba(255,255,255,0.05);
            color: #aaa;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .outpost-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .outpost-btn.active {
            border-color: #ffd700;
            color: #ffd700;
            background: rgba(255,215,0,0.1);
        }
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .resource-input {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 10px;
        }
        .resource-input label { flex: 1; font-weight: 500; }
        .resource-input input {
            width: 100px;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 16px;
        }
        .btn {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #1a1a2e;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .results { display: none; }
        .results.show { display: block; }
        .total-bonds {
            text-align: center;
            font-size: 48px;
            color: #ffd700;
            margin: 20px 0;
        }
        .total-bonds span { font-size: 24px; color: #aaa; }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .item-card {
            background: rgba(0,0,0,0.3);
            padding: 12px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #4fc3f7;
        }
        .item-card.high { border-left-color: #ffd700; }
        .item-card.medium { border-left-color: #ff9800; }
        .item-card .name { flex: 1; }
        .item-card .bonds {
            color: #ffd700;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }
        .info {
            background: rgba(33,150,243,0.2);
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }
        .selected-location {
            color: #ffd700;
            font-size: 14px;
            margin-top: 10px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { color: #4fc3f7; background: rgba(0,0,0,0.2); }
        .section-title { color: #ffd700; margin: 20px 0 10px; font-size: 18px; }
        .energy-panel {
            background: linear-gradient(135deg, rgba(255,100,0,0.2) 0%, rgba(255,50,0,0.1) 100%);
            border: 2px solid #ff6600;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
        }
        .energy-panel h3 {
            color: #ff9800;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .energy-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .energy-row:last-child { border-bottom: none; }
        .energy-row .label { color: #ccc; }
        .energy-row .value { color: #ff9800; font-weight: bold; }
        .energy-total {
            font-size: 24px;
            color: #ff6600;
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ff6600;
        }
        .facilities-panel {
            background: linear-gradient(135deg, rgba(79,195,247,0.15) 0%, rgba(33,150,243,0.1) 100%);
            border: 2px solid #4fc3f7;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
        }
        .facilities-panel h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .facilities-table {
            width: 100%;
            border-collapse: collapse;
        }
        .facilities-table th {
            background: rgba(0,0,0,0.3);
            color: #4fc3f7;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
        .facilities-table td {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
        }
        .facilities-table tr:last-child td { border-bottom: none; }
        .facilities-table .number { text-align: center; color: #ffd700; font-weight: bold; }
        .facilities-table .size { text-align: center; color: #888; }
        .facilities-table .area { text-align: right; color: #4fc3f7; }
        .facilities-table .total-row td {
            background: rgba(0,0,0,0.3);
            font-weight: bold;
            border-top: 2px solid #4fc3f7;
        }
        .facilities-table .battery-row td { color: #ff9800; }
        .facilities-table .gen-row td { color: #ff6600; }
        .area-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 12px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .area-box {
            text-align: center;
        }
        .area-box .label { font-size: 12px; color: #888; }
        .area-box .value { font-size: 24px; font-weight: bold; }
        .area-box.used .value { color: #4fc3f7; }
        .area-box.available .value { color: #ffd700; }
        .area-box.remaining .value { color: #4caf50; }
        .area-box.over .value { color: #f44336; }
        .ore-lines-panel {
            background: linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,140,0,0.1) 100%);
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
        }
        .ore-lines-panel h3 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .ore-lines-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .ore-line-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .ore-line-box .icon { font-size: 24px; }
        .ore-line-box .label { font-size: 11px; color: #888; margin-top: 4px; }
        .ore-line-box .value { font-size: 28px; font-weight: bold; color: #ffd700; }
        .ore-line-box .rate { font-size: 11px; color: #aaa; }
        .ore-line-box.total { background: rgba(255,215,0,0.2); }
        .ore-line-box.total .value { color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Arknights: Endfield - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–ª–∏–≥–∞—Ü–∏–π</h1>
        <div style="text-align:center;margin-bottom:20px">
            <a href="layout_v2.html" style="color:#4fc3f7;font-size:14px">–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ö–µ–º —Ñ–∞–±—Ä–∏–∫–∏</a>
        </div>

        <div class="panel">
            <h2>üìç –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</h2>
            <div class="region-selector" id="regionSelector"></div>
            <div class="selected-location" id="selectedLocation"></div>
        </div>

        <div class="panel">
            <h2>‚õèÔ∏è –î–æ–±—ã—á–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ (–≤ –º–∏–Ω—É—Ç—É)</h2>
            <div class="resources-grid">
                <div class="resource-input">
                    <label>üü° –û—Ä–∏–¥–∂–∏–Ω–∏–µ–≤–∞—è —Ä—É–¥–∞/–º–∏–Ω</label>
                    <input type="number" id="originium_ore" value="360" min="0" step="0.1">
                </div>
                <div class="resource-input">
                    <label>üü£ –ê–º–µ—Ç–∏—Å—Ç–æ–≤–∞—è —Ä—É–¥–∞/–º–∏–Ω</label>
                    <input type="number" id="amethyst_ore" value="240" min="0" step="0.1">
                </div>
                <div class="resource-input">
                    <label>üîµ –§–µ—Ä—Ä–∏–µ–≤–∞—è —Ä—É–¥–∞/–º–∏–Ω</label>
                    <input type="number" id="ferrite_ore" value="1080" min="0" step="0.1">
                </div>
            </div>
            <button class="btn" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            <div id="calcResult" style="display:none; margin-top:20px;">
                <div class="total-bonds">
                    <span>–°–∫–æ—Ä–æ—Å—Ç—å –æ–±–ª–∏–≥–∞—Ü–∏–π:</span><br>
                    <span id="totalBonds">0</span>
                </div>
                <div class="section-title">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ:</div>
                <div class="items-grid" id="craftList"></div>
            </div>
        </div>

        <div class="panel">
            <h2>üîß –†–µ—Ü–µ–ø—Ç—ã —Å –æ–±–ª–∏–≥–∞—Ü–∏—è–º–∏</h2>
            <table id="allRecipesTable">
                <thead>
                    <tr><th style="width:40px"><input type="checkbox" id="checkAllRecipes" checked onchange="toggleAllRecipes(this.checked)"></th><th>–¢–æ–≤–∞—Ä</th><th>–û–±–ª–∏–≥–∞—Ü–∏–∏</th><th>–ì–¥–µ –ø—Ä–æ–¥–∞—ë—Ç—Å—è</th><th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
    let sellableData = null;
    let allRecipes = [];
    let selectedRegion = null;

    async function loadData() {
        try {
            const resp = await fetch('data/sellable_items.json');
            sellableData = await resp.json();
            renderRegions();
        } catch (e) {
            console.error('Failed to load sellable items', e);
        }

        const recipeFiles = [
            'recipes_furnace.json',
            'recipes_grinder.json',
            'recipes_stamping.json',
            'recipes_shaping.json',
            'recipes_thickener.json',
            'recipes_filling.json',
            'recipes_packaging.json',
            'recipes_planter.json',
            'recipes_seeds.json',
            'recipes_celestial_forge.json',
            'recipes_reactor.json',
            'recipes_dismantler.json',
            'recipes_equipment.json'
        ];

        for (const file of recipeFiles) {
            try {
                const resp = await fetch('data/' + file);
                const data = await resp.json();
                allRecipes.push(data);
            } catch (e) {
                console.warn('Failed to load ' + file, e);
            }
        }

        buildRecipeIndex();
        renderAllRecipes();
    }

    let recipeIndex = {};

    function buildRecipeIndex() {
        recipeIndex = {};
        for (const facility of allRecipes) {
            for (const recipe of facility.recipes) {
                const outputItem = recipe.output[0].item;
                if (!recipeIndex[outputItem]) {
                    recipeIndex[outputItem] = [];
                }
                recipeIndex[outputItem].push({
                    ...recipe,
                    facility: facility.facility_id
                });
            }
        }
    }

    const FREE_PLANTS = ['buckwheat', 'citrom', 'sandleaf', 'aketin', 'jinzao', 'yazhen'];
    const FREE_SEEDS = ['buckwheat_seed', 'citrom_seed', 'sandleaf_seed', 'aketin_seed', 'jinzao_seed', 'yazhen_seed'];
    const FREE_RESOURCES = ['clean_water'];
    const PLANT_CYCLE_TIME = 4;

    function calcRawCost(itemId, amount, memo = {}) {
        const key = `${itemId}:${amount}`;
        if (memo[key]) return memo[key];

        const rawOres = ['originium_ore', 'amethyst_ore', 'ferrite_ore'];
        if (rawOres.includes(itemId)) {
            return memo[key] = { [itemId]: amount, facilityTime: {} };
        }

        if (FREE_PLANTS.includes(itemId)) {
            return memo[key] = { plants: amount, facilityTime: { planter: amount * PLANT_CYCLE_TIME } };
        }

        if (FREE_SEEDS.includes(itemId)) {
            return memo[key] = { plants: amount, facilityTime: { seed_collector: amount * 2 } };
        }

        if (FREE_RESOURCES.includes(itemId)) {
            return memo[key] = { clean_water: amount, facilityTime: {} };
        }

        const recipes = recipeIndex[itemId];
        if (!recipes || recipes.length === 0) {
            return memo[key] = { unavailable: itemId, facilityTime: {} };
        }

        const recipe = recipes[0];
        const facility = recipe.facility || 'unknown';
        const outputAmount = recipe.output[0].amount;
        const craftCount = Math.ceil(amount / outputAmount);
        const craftTime = craftCount * recipe.time;

        let totalCost = { facilityTime: { [facility]: craftTime } };
        for (const input of recipe.input) {
            const inputCost = calcRawCost(input.item, input.amount * craftCount, memo);
            for (const [res, qty] of Object.entries(inputCost)) {
                if (res === 'facilityTime') {
                    for (const [fac, time] of Object.entries(qty)) {
                        totalCost.facilityTime[fac] = (totalCost.facilityTime[fac] || 0) + time;
                    }
                } else if (res === 'plants') {
                    totalCost.plants = (totalCost.plants || 0) + qty;
                } else {
                    totalCost[res] = (totalCost[res] || 0) + qty;
                }
            }
        }

        return memo[key] = totalCost;
    }

    function renderRegions() {
        const container = document.getElementById('regionSelector');
        container.innerHTML = '';

        for (const region of sellableData.regions) {
            const btn = document.createElement('button');
            btn.className = 'region-btn';
            btn.textContent = `${region.name} (–†–µ–≥–∏–æ–Ω ${region.number})`;
            btn.onclick = () => selectRegion(region);
            container.appendChild(btn);
        }

        if (sellableData.regions.length > 0) {
            selectRegion(sellableData.regions[0]);
        }
    }

    function selectRegion(region) {
        selectedRegion = region;

        document.querySelectorAll('.region-btn').forEach((btn, i) => {
            btn.classList.toggle('active', sellableData.regions[i].id === region.id);
        });

        document.getElementById('selectedLocation').textContent =
            `–í—ã–±—Ä–∞–Ω–æ: ${region.name} (${region.outposts.length} –∞–≤–∞–Ω–ø–æ—Å—Ç–æ–≤)`;
    }

    function toggleAllRecipes(checked) {
        document.querySelectorAll('.recipe-checkbox').forEach(cb => {
            cb.checked = checked;
        });
    }

    const CONVEYOR_SPEED = 30;
    const FACILITY_NAMES = {
        furnace: '–û—á–∏—Å—Ç–∫–∞',
        grinder: '–ü–µ—Ä–µ–º–∞–ª—ã–≤–∞–Ω–∏–µ',
        stamping: '–®—Ç–∞–º–ø–æ–≤–∫–∞',
        shaping: '–§–æ—Ä–º–æ–≤–∫–∞',
        thickener: '–ò–∑–º–µ–ª—å—á–µ–Ω–∏–µ',
        filling: '–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ',
        packaging: '–£–ø–∞–∫–æ–≤–∫–∞',
        planter: '–ü–æ—Å–∞–¥–∫–∞',
        seed_collector: '–°–±–æ—Ä —Å–µ–º—è–Ω',
        celestial_forge: '–ù–µ–±–µ—Å–Ω–∞—è –∫—É–∑–Ω–∏—Ü–∞',
        reactor: '–†–µ–∞–∫—Ç–æ—Ä',
        dismantler: '–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ',
        equipment: '–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ'
    };

    const DRILL_RATE = 10;
    const PUMP_RATE = 60;
    const DRILL_POWER = 10;
    const PUMP_POWER = 10;
    const PLOT_BLOCKED_AREA = 81;
    const FACILITY_SPACING = 2;
    const PYLON_COVERAGE = 144;
    const PYLON_SIZE = 4;

    const GENERATORS = [
        { id: 'gen_ulin', name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', energy: 1600, burnTime: 40, battery: 'battery_me_ulin', batteryName: '–ë–∞—Ç–∞—Ä–µ—è ME –£–ª–∏–Ω–∞', region: 'ulin', area: 4, size: '2x2' },
        { id: 'gen_valley', name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', energy: 1100, burnTime: 40, battery: 'battery_be_valley', batteryName: '–ë–∞—Ç–∞—Ä–µ—è BE –î–æ–ª–∏–Ω—ã', region: 'valley', area: 4, size: '2x2' },
        { id: 'gen_ce', name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', energy: 420, burnTime: 40, battery: 'battery_ce_valley', batteryName: '–ë–∞—Ç–∞—Ä–µ—è CE –î–æ–ª–∏–Ω—ã', region: 'valley', area: 4, size: '2x2' },
        { id: 'gen_me', name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', energy: 220, burnTime: 40, battery: 'battery_me_valley', batteryName: '–ë–∞—Ç–∞—Ä–µ—è ME –î–æ–ª–∏–Ω—ã', region: 'valley', area: 4, size: '2x2' },
        { id: 'gen_ore', name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', energy: 50, burnTime: 8, battery: 'originium_ore', batteryName: '–û—Ä–∏–¥–∂–∏–Ω–∏–µ–≤–∞—è —Ä—É–¥–∞', region: 'all', area: 4, size: '2x2' }
    ];

    function getFacilityPower(facilityId) {
        for (const facility of allRecipes) {
            if (facility.facility_id === facilityId) {
                return facility.power || 0;
            }
        }
        return 0;
    }

    function getFacilityArea(facilityId) {
        for (const facility of allRecipes) {
            if (facility.facility_id === facilityId) {
                return facility.area || 0;
            }
        }
        return 0;
    }

    function getFacilitySize(facilityId) {
        for (const facility of allRecipes) {
            if (facility.facility_id === facilityId) {
                return facility.size || '';
            }
        }
        return '';
    }

    function getEffectiveArea(facilityId) {
        const size = getFacilitySize(facilityId);
        if (!size) return getFacilityArea(facilityId);
        const parts = size.split('x');
        if (parts.length !== 2) return getFacilityArea(facilityId);
        const w = parseInt(parts[0]);
        const h = parseInt(parts[1]) + FACILITY_SPACING;
        return w * h;
    }

    function getEffectiveAreaFromSize(sizeStr) {
        if (!sizeStr) return 0;
        const parts = sizeStr.split('x');
        if (parts.length !== 2) return 0;
        const w = parseInt(parts[0]);
        const h = parseInt(parts[1]) + FACILITY_SPACING;
        return w * h;
    }

    function calcFacilitiesNeeded(itemId, ratePerMin, memo = {}) {
        const facilities = {};

        const rawOres = ['originium_ore', 'amethyst_ore', 'ferrite_ore'];
        if (rawOres.includes(itemId) || FREE_RESOURCES.includes(itemId)) {
            return facilities;
        }

        if (FREE_PLANTS.includes(itemId)) {
            const planterRate = 30;
            const seedCollectorRate = 30;
            const totalPlantsNeeded = ratePerMin * 2;
            const plantsForSeeds = ratePerMin;
            facilities['planter'] = Math.ceil(totalPlantsNeeded / planterRate);
            facilities['seed_collector'] = Math.ceil(plantsForSeeds / seedCollectorRate);
            return facilities;
        }

        if (FREE_SEEDS.includes(itemId)) {
            const seedCollectorRate = 60;
            facilities['seed_collector'] = Math.ceil(ratePerMin / seedCollectorRate);
            return facilities;
        }

        const recipes = recipeIndex[itemId];
        if (!recipes || recipes.length === 0) return facilities;

        const recipe = recipes[0];
        const facility = recipe.facility || 'unknown';
        const outputAmount = recipe.output[0].amount;
        const craftTime = recipe.time;

        const itemsPerMinPerFacility = (60 / craftTime) * outputAmount;
        const facilitiesNeeded = Math.ceil(ratePerMin / itemsPerMinPerFacility);

        facilities[facility] = (facilities[facility] || 0) + facilitiesNeeded;

        for (const input of recipe.input) {
            const inputRateNeeded = (input.amount / outputAmount) * ratePerMin;
            const subFacilities = calcFacilitiesNeeded(input.item, inputRateNeeded, memo);
            for (const [fac, count] of Object.entries(subFacilities)) {
                facilities[fac] = (facilities[fac] || 0) + count;
            }
        }

        return facilities;
    }

    function findBestGenerator(totalEnergy, regionId) {
        let bestGen = null;
        let bestTotalOreCost = Infinity;
        let bestInfo = {};

        const availableGens = GENERATORS.filter(g => g.region === 'all' || g.region === regionId);
        for (const gen of availableGens) {
            const generatorsNeeded = Math.ceil(totalEnergy / gen.energy);
            const batteriesPerMin = generatorsNeeded * (60 / gen.burnTime);

            let lostBonds = 0;
            let oreCost = { originium_ore: 0, amethyst_ore: 0, ferrite_ore: 0 };

            if (gen.battery === 'originium_ore') {
                oreCost.originium_ore = batteriesPerMin;
            } else {
                for (const facility of allRecipes) {
                    for (const recipe of facility.recipes) {
                        if (recipe.output[0].item === gen.battery && recipe.bonds) {
                            lostBonds = recipe.bonds * batteriesPerMin;
                        }
                    }
                }
                const cost = calcRawCost(gen.battery, 1);
                oreCost.originium_ore = (cost.originium_ore || 0) * batteriesPerMin;
                oreCost.amethyst_ore = (cost.amethyst_ore || 0) * batteriesPerMin;
                oreCost.ferrite_ore = (cost.ferrite_ore || 0) * batteriesPerMin;
            }

            const totalOreCost = oreCost.originium_ore + oreCost.amethyst_ore + oreCost.ferrite_ore;

            if (totalOreCost < bestTotalOreCost) {
                bestTotalOreCost = totalOreCost;
                bestGen = gen;
                bestInfo = { generatorsNeeded, batteriesPerMin, lostBonds, oreCost };
            }
        }

        return { gen: bestGen, info: bestInfo };
    }

    function calculate() {
        const inputOre = {
            originium_ore: parseFloat(document.getElementById('originium_ore').value) || 0,
            amethyst_ore: parseFloat(document.getElementById('amethyst_ore').value) || 0,
            ferrite_ore: parseFloat(document.getElementById('ferrite_ore').value) || 0
        };

        const enabledRecipes = new Set();
        document.querySelectorAll('.recipe-checkbox:checked').forEach(cb => {
            enabledRecipes.add(cb.dataset.item);
        });

        let batteryOreCost = { originium_ore: 0, amethyst_ore: 0, ferrite_ore: 0 };
        let bestGenerator = null;
        let iterations = 0;
        const MAX_ITERATIONS = 5;

        const sellableRecipes = [];
        for (const facility of allRecipes) {
            for (const recipe of facility.recipes) {
                if (recipe.bonds && enabledRecipes.has(recipe.output[0].item)) {
                    const itemId = recipe.output[0].item;
                    const cost = calcRawCost(itemId, 1);

                    if (!cost.unavailable) {
                        const totalOre = (cost.originium_ore || 0) + (cost.amethyst_ore || 0) + (cost.ferrite_ore || 0);
                        sellableRecipes.push({
                            item: itemId,
                            name: recipe.output[0].name_ru,
                            bonds: recipe.bonds,
                            cost: cost,
                            oreEfficiency: totalOre > 0 ? recipe.bonds / totalOre : Infinity
                        });
                    }
                }
            }
        }

        sellableRecipes.sort((a, b) => b.oreEfficiency - a.oreEfficiency);

        let totalBondsPerMin = 0;
        let details = [];
        let remainingRate = {};
        let available = {};
        let totalFacilities = {};
        let drillsNeeded = 0, pumpsNeeded = 0;
        let drillEnergy = 0, pumpEnergy = 0, facilityEnergy = 0;
        let facilityEnergyDetails = [];
        let totalEnergy = 0;
        let totalWaterPerMin = 0;
        let usedOrePerMin = 0;
        let usedOreByType = { originium: 0, amethyst: 0, ferrite: 0 };
        let oreLines = { originium: 0, amethyst: 0, ferrite: 0, total: 0 };
        let batteryFacilities = {};
        let batteryFacilityEnergy = 0;

        while (iterations < MAX_ITERATIONS) {
            iterations++;

            available = {
                originium_ore: Math.max(0, inputOre.originium_ore - batteryOreCost.originium_ore),
                amethyst_ore: Math.max(0, inputOre.amethyst_ore - batteryOreCost.amethyst_ore),
                ferrite_ore: Math.max(0, inputOre.ferrite_ore - batteryOreCost.ferrite_ore)
            };

            totalBondsPerMin = 0;
            details = [];
            remainingRate = { ...available };
            totalFacilities = {};

            console.log('=== –ù–∞—á–∞–ª–æ —Ä–∞—Å—á—ë—Ç–∞ ===');
            console.log('–î–æ—Å—Ç—É–ø–Ω–æ —Ä—É–¥—ã/–º–∏–Ω:', available);

            for (const recipe of sellableRecipes) {
                let maxItems = Infinity;
                for (const [ore, need] of Object.entries(recipe.cost)) {
                    if (ore === 'facilityTime' || ore === 'plants') continue;
                    if (remainingRate[ore] !== undefined && need > 0) {
                        const possible = remainingRate[ore] / need;
                        maxItems = Math.min(maxItems, possible);
                    }
                }

                if (maxItems > 0.01 && maxItems !== Infinity) {
                    for (const [ore, need] of Object.entries(recipe.cost)) {
                        if (ore === 'facilityTime' || ore === 'plants') continue;
                        if (remainingRate[ore] !== undefined) {
                            remainingRate[ore] -= need * maxItems;
                        }
                    }

                    const bondsPerMin = recipe.bonds * maxItems;
                    totalBondsPerMin += bondsPerMin;

                    const facilities = calcFacilitiesNeeded(recipe.item, maxItems);

                    console.log(`${recipe.name}: ${maxItems.toFixed(2)}/–º–∏–Ω = ${bondsPerMin.toFixed(1)} –æ–±–ª/–º–∏–Ω`);

                    details.push({
                        item: recipe.item,
                        name: recipe.name,
                        rate: maxItems,
                        bondsPerMin: bondsPerMin,
                        facilities: facilities
                    });
                }
            }

            console.log('=== –ò—Ç–æ–≥–æ ===');
            for (const d of details) {
                if (d.facilities) {
                    for (const [f, c] of Object.entries(d.facilities)) {
                        totalFacilities[f] = (totalFacilities[f] || 0) + c;
                    }
                }
            }

            totalWaterPerMin = 0;
            for (const d of details) {
                const cost = calcRawCost(d.item || '', 1);
                if (cost.clean_water) {
                    totalWaterPerMin += cost.clean_water * d.rate;
                }
            }

            const totalOrePerMin = available.originium_ore + available.amethyst_ore + available.ferrite_ore;
            usedOrePerMin = totalOrePerMin - (remainingRate.originium_ore + remainingRate.amethyst_ore + remainingRate.ferrite_ore);

            usedOreByType = {
                originium: available.originium_ore - remainingRate.originium_ore,
                amethyst: available.amethyst_ore - remainingRate.amethyst_ore,
                ferrite: available.ferrite_ore - remainingRate.ferrite_ore
            };

            oreLines = {
                originium: Math.ceil(usedOreByType.originium / CONVEYOR_SPEED),
                amethyst: Math.ceil(usedOreByType.amethyst / CONVEYOR_SPEED),
                ferrite: Math.ceil(usedOreByType.ferrite / CONVEYOR_SPEED),
                total: Math.ceil(usedOreByType.originium / CONVEYOR_SPEED) + Math.ceil(usedOreByType.amethyst / CONVEYOR_SPEED) + Math.ceil(usedOreByType.ferrite / CONVEYOR_SPEED)
            };

            drillsNeeded = Math.ceil(usedOrePerMin / DRILL_RATE);
            pumpsNeeded = Math.ceil(totalWaterPerMin / PUMP_RATE);

            drillEnergy = drillsNeeded * DRILL_POWER;
            pumpEnergy = pumpsNeeded * PUMP_POWER;

            facilityEnergy = 0;
            facilityEnergyDetails = [];
            for (const [facilityId, count] of Object.entries(totalFacilities)) {
                const power = getFacilityPower(facilityId);
                const energy = power * count;
                facilityEnergy += energy;
                if (energy > 0) {
                    facilityEnergyDetails.push({
                        name: FACILITY_NAMES[facilityId] || facilityId,
                        count: count,
                        power: power,
                        energy: energy
                    });
                }
            }

            totalEnergy = drillEnergy + pumpEnergy + facilityEnergy;

            bestGenerator = findBestGenerator(totalEnergy, selectedRegion.id);

            batteryFacilities = {};
            batteryFacilityEnergy = 0;
            if (bestGenerator.gen && bestGenerator.gen.battery !== 'originium_ore') {
                batteryFacilities = calcFacilitiesNeeded(bestGenerator.gen.battery, bestGenerator.info.batteriesPerMin);
                for (const [facilityId, count] of Object.entries(batteryFacilities)) {
                    const power = getFacilityPower(facilityId);
                    batteryFacilityEnergy += power * count;
                }
            }

            const totalEnergyWithBatteries = totalEnergy + batteryFacilityEnergy;
            bestGenerator = findBestGenerator(totalEnergyWithBatteries, selectedRegion.id);

            if (bestGenerator.gen && bestGenerator.gen.battery !== 'originium_ore') {
                batteryFacilities = calcFacilitiesNeeded(bestGenerator.gen.battery, bestGenerator.info.batteriesPerMin);
                batteryFacilityEnergy = 0;
                for (const [facilityId, count] of Object.entries(batteryFacilities)) {
                    const power = getFacilityPower(facilityId);
                    batteryFacilityEnergy += power * count;
                }
            }

            totalEnergy = totalEnergyWithBatteries;

            const newBatteryCost = bestGenerator.info.oreCost;

            const costChanged =
                Math.abs(newBatteryCost.originium_ore - batteryOreCost.originium_ore) > 1 ||
                Math.abs(newBatteryCost.amethyst_ore - batteryOreCost.amethyst_ore) > 1 ||
                Math.abs(newBatteryCost.ferrite_ore - batteryOreCost.ferrite_ore) > 1;

            batteryOreCost = { ...newBatteryCost };

            if (!costChanged || iterations >= MAX_ITERATIONS) {
                break;
            }
        }

        const totalOreForBatteries = batteryOreCost.originium_ore + batteryOreCost.amethyst_ore + batteryOreCost.ferrite_ore;

        const netBonds = totalBondsPerMin - (bestGenerator?.info?.lostBonds || 0);

        document.getElementById('totalBonds').innerHTML =
            `${netBonds.toFixed(1)} <span style="font-size:18px;color:#4fc3f7">–æ–±–ª/–º–∏–Ω (—á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å)</span>`;

        const craftList = document.getElementById('craftList');
        let craftHtml = '';

        for (const d of details) {
            let facInfo = '';
            if (d.facilities && Object.keys(d.facilities).length > 0) {
                const facList = Object.entries(d.facilities)
                    .map(([f, c]) => `${FACILITY_NAMES[f] || f}: ${c}`)
                    .join(', ');
                facInfo = `<div style="font-size:11px;color:#888;margin-top:3px">${facList}</div>`;
            }
            craftHtml += `<div class="item-card">
                <span class="name">${d.name}${facInfo}</span>
                <span class="bonds">${d.rate.toFixed(2)}/–º–∏–Ω = ${d.bondsPerMin.toFixed(1)} –æ–±–ª/–º–∏–Ω</span>
            </div>`;
        }

        if (bestGenerator && bestGenerator.gen && bestGenerator.gen.battery !== 'originium_ore') {
            let batteryName = bestGenerator.gen.battery;
            for (const facility of allRecipes) {
                for (const recipe of facility.recipes) {
                    if (recipe.output[0].item === bestGenerator.gen.battery) {
                        batteryName = recipe.output[0].name_ru;
                        break;
                    }
                }
            }
            let batteryFacInfo = '';
            if (Object.keys(batteryFacilities).length > 0) {
                const facList = Object.entries(batteryFacilities)
                    .map(([f, c]) => `${FACILITY_NAMES[f] || f}: ${c}`)
                    .join(', ');
                batteryFacInfo = `<div style="font-size:11px;color:#888;margin-top:3px">${facList}</div>`;
            }
            craftHtml += `<div class="item-card" style="border-left-color:#ff6600">
                <span class="name">${batteryName} (–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä)${batteryFacInfo}</span>
                <span class="bonds" style="color:#ff9800">${bestGenerator.info.batteriesPerMin.toFixed(2)}/–º–∏–Ω</span>
            </div>`;
        }

        const baseOutputs = selectedRegion.base_outputs || 0;
        const outpostOutputs = selectedRegion.outposts.reduce((sum, o) => sum + (o.outputs || 0), 0);
        const totalOutputs = baseOutputs + outpostOutputs;
        const outputsRemaining = totalOutputs - oreLines.total;

        craftHtml += `<div class="ore-lines-panel">
            <h3>‚õèÔ∏è –í—Ö–æ–¥–Ω—ã–µ –ª–∏–Ω–∏–∏ —Ä—É–¥—ã (–∫–æ–Ω–≤–µ–π–µ—Ä ${CONVEYOR_SPEED}/–º–∏–Ω)</h3>
            <div class="ore-lines-grid">
                <div class="ore-line-box">
                    <div class="icon">üü°</div>
                    <div class="label">–û—Ä–∏–¥–∂–∏–Ω–∏–π</div>
                    <div class="value">${oreLines.originium}</div>
                    <div class="rate">${usedOreByType.originium.toFixed(0)}/–º–∏–Ω</div>
                </div>
                <div class="ore-line-box">
                    <div class="icon">üü£</div>
                    <div class="label">–ê–º–µ—Ç–∏—Å—Ç</div>
                    <div class="value">${oreLines.amethyst}</div>
                    <div class="rate">${usedOreByType.amethyst.toFixed(0)}/–º–∏–Ω</div>
                </div>
                <div class="ore-line-box">
                    <div class="icon">üîµ</div>
                    <div class="label">–§–µ—Ä—Ä–∏–π</div>
                    <div class="value">${oreLines.ferrite}</div>
                    <div class="rate">${usedOreByType.ferrite.toFixed(0)}/–º–∏–Ω</div>
                </div>
                <div class="ore-line-box total">
                    <div class="icon">üì¶</div>
                    <div class="label">–í–°–ï–ì–û –ª–∏–Ω–∏–π</div>
                    <div class="value">${oreLines.total}</div>
                    <div class="rate">${usedOrePerMin.toFixed(0)}/–º–∏–Ω</div>
                </div>
            </div>
            ${totalOutputs > 0 ? `<div class="area-summary" style="margin-top:12px">
                <div class="area-box used">
                    <div class="label">–ó–∞–Ω—è—Ç–æ –≤—ã—Ö–æ–¥–æ–≤</div>
                    <div class="value">${oreLines.total}</div>
                </div>
                <div class="area-box available">
                    <div class="label">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                    <div class="value">${totalOutputs}</div>
                    <div style="font-size:10px;color:#888;margin-top:2px">–ë–∞–∑–∞: ${baseOutputs} + ${selectedRegion.outposts.length} –∞–≤–∞–Ω–ø. √ó 16</div>
                </div>
                <div class="area-box ${outputsRemaining >= 0 ? 'remaining' : 'over'}">
                    <div class="label">${outputsRemaining >= 0 ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç!'}</div>
                    <div class="value">${Math.abs(outputsRemaining)}</div>
                </div>
            </div>` : ''}
        </div>`;

        if (Object.keys(totalFacilities).length > 0 || Object.keys(batteryFacilities).length > 0) {
            let totalEffectiveArea = 0;
            let tableRows = '';

            for (const [f, c] of Object.entries(totalFacilities)) {
                const size = getFacilitySize(f);
                const parts = size.split('x');
                const effSize = parts.length === 2 ? `${parts[0]}√ó${parseInt(parts[1])+1}` : size;
                const effArea = getEffectiveArea(f);
                const subtotal = effArea * c;
                totalEffectiveArea += subtotal;
                tableRows += `<tr>
                    <td>${FACILITY_NAMES[f] || f}</td>
                    <td class="size">${effSize}</td>
                    <td class="number">${c}</td>
                    <td class="area">${subtotal}</td>
                </tr>`;
            }

            for (const [f, c] of Object.entries(batteryFacilities)) {
                const size = getFacilitySize(f);
                const parts = size.split('x');
                const effSize = parts.length === 2 ? `${parts[0]}√ó${parseInt(parts[1])+1}` : size;
                const effArea = getEffectiveArea(f);
                const subtotal = effArea * c;
                totalEffectiveArea += subtotal;
                tableRows += `<tr class="battery-row">
                    <td>üîã ${FACILITY_NAMES[f] || f}</td>
                    <td class="size">${effSize}</td>
                    <td class="number">${c}</td>
                    <td class="area">${subtotal}</td>
                </tr>`;
            }

            if (bestGenerator && bestGenerator.gen) {
                const genSize = bestGenerator.gen.size;
                const genParts = genSize.split('x');
                const genEffSize = genParts.length === 2 ? `${genParts[0]}√ó${parseInt(genParts[1])+1}` : genSize;
                const genEffArea = getEffectiveAreaFromSize(bestGenerator.gen.size) * bestGenerator.info.generatorsNeeded;
                totalEffectiveArea += genEffArea;
                tableRows += `<tr class="gen-row">
                    <td>‚ö° ${bestGenerator.gen.name} (${bestGenerator.gen.batteryName})</td>
                    <td class="size">${genEffSize}</td>
                    <td class="number">${bestGenerator.info.generatorsNeeded}</td>
                    <td class="area">${genEffArea}</td>
                </tr>`;
            }

            const pylonsNeeded = Math.ceil(totalEffectiveArea / PYLON_COVERAGE);
            const pylonArea = pylonsNeeded * PYLON_SIZE;
            totalEffectiveArea += pylonArea;

            tableRows += `<tr style="color:#9c27b0">
                <td>üîå –ü–∏–ª–æ–Ω—ã (12√ó12 –∑–æ–Ω–∞)</td>
                <td class="size">2√ó2</td>
                <td class="number">${pylonsNeeded}</td>
                <td class="area">${pylonArea}</td>
            </tr>`;

            const plotCount = 1 + selectedRegion.outposts.length;
            const blockedByStructures = plotCount * PLOT_BLOCKED_AREA;
            const grossArea = selectedRegion.base_area + selectedRegion.outposts.reduce((sum, o) => sum + o.area, 0);
            const availableArea = grossArea - blockedByStructures;
            const remainingArea = availableArea - totalEffectiveArea;

            craftHtml += `<div class="facilities-panel">
                <h3>üè≠ –°—Ç–∞–Ω–∫–∏ –∏ –ø–ª–æ—â–∞–¥—å</h3>
                <table class="facilities-table">
                    <thead>
                        <tr><th>–°—Ç–∞–Ω–æ–∫</th><th style="text-align:center">–†–∞–∑–º–µ—Ä</th><th style="text-align:center">–ö–æ–ª-–≤–æ</th><th style="text-align:right">–ü–ª–æ—â–∞–¥—å</th></tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                        <tr class="total-row">
                            <td colspan="3">–ò–¢–û–ì–û (—Å –ª–µ–Ω—Ç–∞–º–∏)</td>
                            <td class="area">${totalEffectiveArea} —Ç–∞–π–ª–æ–≤</td>
                        </tr>
                    </tbody>
                </table>
                <div class="area-summary">
                    <div class="area-box used">
                        <div class="label">–ó–∞–Ω—è—Ç–æ (—ç—Ñ—Ñ.)</div>
                        <div class="value">${totalEffectiveArea}</div>
                    </div>
                    <div class="area-box available">
                        <div class="label">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                        <div class="value">${availableArea}</div>
                        <div style="font-size:10px;color:#888;margin-top:2px">${grossArea} ‚àí ${plotCount}√ó81</div>
                    </div>
                    <div class="area-box ${remainingArea >= 0 ? 'remaining' : 'over'}">
                        <div class="label">${remainingArea >= 0 ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç!'}</div>
                        <div class="value">${Math.abs(remainingArea)}</div>
                    </div>
                </div>
            </div>`;
        }

        if (bestGenerator && bestGenerator.gen) {
            craftHtml += `<div class="info" style="margin-top:10px;background:rgba(255,100,0,0.15);border-left-color:#ff6600">
                <b>–†—É–¥–∞ –Ω–∞ –±–∞—Ç–∞—Ä–µ–∏:</b> ${totalOreForBatteries.toFixed(0)}/–º–∏–Ω
                (–û—Ä–∏–¥–∂–∏–Ω–∏–π: ${batteryOreCost.originium_ore.toFixed(0)},
                 –ê–º–µ—Ç–∏—Å—Ç: ${batteryOreCost.amethyst_ore.toFixed(0)},
                 –§–µ—Ä—Ä–∏–π: ${batteryOreCost.ferrite_ore.toFixed(0)})
            </div>`;

            let facilityRows = facilityEnergyDetails.map(f =>
                `<div class="energy-row" style="padding-left:20px;font-size:13px">
                    <span class="label">${f.name} (${f.count} √ó ${f.power})</span>
                    <span class="value">${f.energy}</span>
                </div>`
            ).join('');

            let batteryFacilityRows = '';
            if (batteryFacilityEnergy > 0) {
                batteryFacilityRows = Object.entries(batteryFacilities).map(([facilityId, count]) => {
                    const power = getFacilityPower(facilityId);
                    const energy = power * count;
                    if (energy > 0) {
                        return `<div class="energy-row" style="padding-left:20px;font-size:13px">
                            <span class="label">${FACILITY_NAMES[facilityId] || facilityId} (${count} √ó ${power}) [–±–∞—Ç–∞—Ä–µ–∏]</span>
                            <span class="value">${energy}</span>
                        </div>`;
                    }
                    return '';
                }).join('');
            }

            craftHtml += `
            <div class="energy-panel">
                <h3>‚ö° –≠–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (–∏—Ç–µ—Ä–∞—Ü–∏—è ${iterations})</h3>
                <div class="energy-row">
                    <span class="label">üî® –ë—É—Ä—ã (${drillsNeeded} —à—Ç √ó ${DRILL_POWER} –∫–í—Ç)</span>
                    <span class="value">${drillEnergy} –∫–í—Ç</span>
                </div>
                <div class="energy-row">
                    <span class="label">üíß –ù–∞—Å–æ—Å—ã (${pumpsNeeded} —à—Ç √ó ${PUMP_POWER} –∫–í—Ç)</span>
                    <span class="value">${pumpEnergy} –∫–í—Ç</span>
                </div>
                <div class="energy-row">
                    <span class="label">üè≠ –°—Ç–∞–Ω–∫–∏ (—Ç–æ–≤–∞—Ä—ã)</span>
                    <span class="value">${facilityEnergy} –∫–í—Ç</span>
                </div>
                ${facilityRows}
                <div class="energy-row">
                    <span class="label">üîã –°—Ç–∞–Ω–∫–∏ (–±–∞—Ç–∞—Ä–µ–∏)</span>
                    <span class="value">${batteryFacilityEnergy} –∫–í—Ç</span>
                </div>
                ${batteryFacilityRows}
                <div class="energy-total">
                    –ò–¢–û–ì–û: ${totalEnergy} –∫–í—Ç
                </div>
                <h3 style="margin-top:15px">üîã –õ—É—á—à–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h3>
                <div style="background:rgba(0,255,0,0.15);border-radius:8px;padding:12px;margin:5px 0">
                    <div class="energy-row" style="border:none">
                        <span class="label" style="font-size:16px">‚úÖ ${bestGenerator.gen.name} (${bestGenerator.gen.batteryName})</span>
                        <span class="value">${bestGenerator.info.generatorsNeeded} —à—Ç √ó ${bestGenerator.gen.energy} –∫–í—Ç</span>
                    </div>
                    <div style="margin-top:8px;font-size:13px;color:#aaa">
                        ${bestGenerator.gen.batteryName}: <b style="color:#ff9800">${bestGenerator.info.batteriesPerMin.toFixed(1)}/–º–∏–Ω</b> |
                        –†—É–¥—ã –Ω–∞ –±–∞—Ç–∞—Ä–µ–∏: <b style="color:#ffaa00">${totalOreForBatteries.toFixed(0)}/–º–∏–Ω</b>
                    </div>
                    <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2);text-align:center">
                        <span style="color:#4fc3f7;font-size:20px;font-weight:bold">–ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨: ${netBonds.toFixed(0)} –æ–±–ª/–º–∏–Ω</span>
                    </div>
                </div>
            </div>`;

            console.log('=== –≠–Ω–µ—Ä–≥–∏—è ===');
            console.log('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ä—É–¥—ã/–º–∏–Ω:', usedOrePerMin.toFixed(1));
            console.log('–í–æ–¥—ã/–º–∏–Ω:', totalWaterPerMin.toFixed(1));
            console.log('–ë—É—Ä–æ–≤:', drillsNeeded, '=', drillEnergy, '–∫–í—Ç');
            console.log('–ù–∞—Å–æ—Å–æ–≤:', pumpsNeeded, '=', pumpEnergy, '–∫–í—Ç');
            console.log('–°—Ç–∞–Ω–∫–∏ —Ç–æ–≤–∞—Ä—ã:', facilityEnergy, '–∫–í—Ç');
            console.log('–°—Ç–∞–Ω–∫–∏ –±–∞—Ç–∞—Ä–µ–∏:', batteryFacilityEnergy, '–∫–í—Ç');
            console.log('–ò—Ç–æ–≥–æ:', totalEnergy, '–∫–í—Ç');
        }

        craftList.innerHTML = craftHtml || '<div style="color:#888">–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞</div>';
        document.getElementById('calcResult').style.display = 'block';
    }

    function renderAllRecipes() {
        const tbody = document.querySelector('#allRecipesTable tbody');
        let html = '';

        for (const facility of allRecipes) {
            for (const recipe of facility.recipes) {
                if (recipe.bonds) {
                    const inputs = recipe.input.map(i => `${i.amount} ${i.name_ru}`).join(' + ');
                    const itemId = recipe.output[0].item;

                    let locationInfo = '-';
                    if (sellableData) {
                        const locations = [];
                        for (const region of sellableData.regions) {
                            const outpostNames = [];
                            for (const outpost of region.outposts) {
                                if (outpost.items.some(i => i.item === itemId)) {
                                    outpostNames.push(outpost.name);
                                }
                            }
                            if (outpostNames.length > 0) {
                                if (outpostNames.length === region.outposts.length) {
                                    locations.push(`${region.name}: –≤—Å–µ`);
                                } else {
                                    locations.push(`${region.name}: ${outpostNames.join(', ')}`);
                                }
                            }
                        }
                        locationInfo = locations.length > 0 ? locations.join('; ') : '-';
                    }

                    html += `<tr>
                        <td><input type="checkbox" class="recipe-checkbox" data-item="${itemId}" checked></td>
                        <td>${recipe.output[0].name_ru}</td>
                        <td style="color:#ffd700;font-weight:bold">${recipe.bonds}</td>
                        <td style="font-size:12px">${locationInfo}</td>
                        <td style="font-size:12px">${inputs}</td>
                    </tr>`;
                }
            }
        }
        tbody.innerHTML = html;
    }

    loadData();
    </script>
</body>
</html>
